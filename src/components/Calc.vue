<script setup>
import { ref, onMounted } from 'vue'
import moment from 'moment'
import Total from './Total.vue';
import { Printer } from '@element-plus/icons-vue'


// reactive state
const tableVisible = ref(false)
const sumLoan = ref(50000)
const bet = ref(22)
const periodLoan = ref(1)
const periodType = ref('year')
const periods = [ { value: 'year', label: 'года',}, { value: 'month', label: 'месяца',}]
const dateIssue = ref(moment().format('DD.MM.YYYY'))
const repaymentProcedure = ref('annuity')
const repaymentProcedureType = [ { value: 'annuity', label: 'Аннуитетный',}, { value: 'differentiated', label: 'Дифференцированный',}]
const RepaymentFrequency = ref('monthly')
const RepaymentFrequencyType = [ { value: 'monthly', label: 'Ежемесячно',}, { value: 'quarterly', label: 'Ежеквартально',}, { value: 'annually', label: 'Ежегодно',}]
const oneCommission = ref(0)
const annuallyCommission = ref(0)

const totalAll = ref(0)
const totalPrice = ref(0)
const totalOverpayment = ref(0)

let tablePay = ref([])

function numberWithSpaces(x) {
  return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
}

function calculate() {
    repaymentProcedure.value === 'annuity' ? annuityCalculate() : differentiatedCalculate()
    totalPrice.value = sumLoan.value
}

function annuityCalculate() {
    tablePay.value = []
    let period = periodLoan.value
    if (periodType.value === 'year') {
        period = period * 12
    }

    //ежемесячная процентная ставка
    const p = Number((bet.value /100/12).toFixed(6))

    //сумма ежемесячных отчислений по кредиту
    const n = p / (Math.pow(1+p, period) - 1);
    const annuityPay = sumLoan.value * (p + n)

    const startItem = {
        date: dateIssue.value,
        pay: '0.00',
        percent: '0.00',
        mainDebt: '0.00',
        remainder: sumLoan.value
    }

    //Коммисия
    if(Number(oneCommission.value) > 0){
        startItem.pay = Number(oneCommission.value).toFixed(2)
        startItem.commision = Number(oneCommission.value).toFixed(2)
    }

    tablePay.value.push(startItem)

    let datePay = moment(dateIssue.value, 'DD MM YYYY');
    let remainder = sumLoan.value
    let totalPay = startItem.pay
    let totalPercent = 0

    for (var i = 0; i < period; i++) {
        datePay = moment(datePay).add(1, 'M');
        const percent = remainder * p
        const remainderSum = remainder

        let mainDebt = annuityPay - percent
        remainder = Number(tablePay.value[i].remainder) - mainDebt
        let pay = annuityPay
  
        if((i + 1) === period) {
            mainDebt = Number(tablePay.value[i].remainder)
            pay = percent + Number(tablePay.value[i].remainder)
            remainder = 0
        }

        const tableItem = {
            date: datePay.format('DD.MM.YYYY'),
            pay: pay.toFixed(2),
            percent: percent.toFixed(2),
            mainDebt: mainDebt.toFixed(2),
            remainder: remainder.toFixed(2)
        }

        if(Number(annuallyCommission.value) > 0){
            tableItem.commision = Number(annuallyCommission.value).toFixed(2)
            tableItem.pay = Number(pay.toFixed(2)) + Number(annuallyCommission.value)
        }

        totalPay = Number(totalPay) + Number(tableItem.pay)
        totalPercent = totalPercent + percent
        tablePay.value.push(tableItem)
    }
    totalAll.value = totalPay.toFixed(2)
    totalOverpayment.value = (totalPay.toFixed(2) - Number(sumLoan.value)).toFixed(2)
}

function differentiatedCalculate() {
    tablePay.value = []
    let period = periodLoan.value
    if (periodType.value === 'year') {
        period = period * 12
    }
    //Расчет доли тела кредита в дифференцированных платежах
    const S = sumLoan.value / period

    //Расчет доли процентов в дифференцированных платежах
    const sn = sumLoan.value - S
    const I = (sn * (bet.value / 100)) / 12
    
    //Дифференцированный платеж
    const p = S + I

    //Всего выплат
    let totalPay = 0

    const startItem = {
        date: dateIssue.value,
        pay: '0.00',
        percent: '0.00',
        mainDebt: '0.00',
        remainder: sumLoan.value
    }
    //Коммисия
    if(Number(oneCommission.value) > 0){
        startItem.pay = Number(oneCommission.value).toFixed(2)
        startItem.commision = Number(oneCommission.value).toFixed(2)
        totalPay = startItem.commision
    }
    tablePay.value.push(startItem)

    let datePay = moment(dateIssue.value, 'DD MM YYYY');
    let remainder = sumLoan.value
    
    let totalPercent = 0

    for (var i = 0; i < period; i++) {
        datePay = moment(datePay).add(1, 'M');

        //Расчет процента на основе остатка
        const percent = (remainder * (bet.value / 100)) / 12
        let pay = percent + S
        remainder = remainder - S

        const tableItem = {
            date: datePay.format('DD.MM.YYYY'),
            pay: pay.toFixed(2),
            percent: percent.toFixed(2),
            mainDebt: S.toFixed(2),
            remainder: remainder.toFixed(2)
        }

        //Коммисия
        if(Number(annuallyCommission.value) > 0){
            tableItem.commision = Number(annuallyCommission.value).toFixed(2)
            tableItem.pay = Number(pay.toFixed(2)) + Number(annuallyCommission.value)
        }
        tablePay.value.push(tableItem)
        totalPay = Number(totalPay) + Number(tableItem.pay)
        totalPercent = totalPercent + percent
    }
    totalAll.value = totalPay.toFixed(2)
    totalOverpayment.value = (totalPay.toFixed(2) - Number(sumLoan.value)).toFixed(2)
}

function print() {
    window.print();
    // window.location.reload();
}

onMounted(() => {
    calculate()
})
</script>
<template>
  <div class="calc center">
    <div class="d-content">
        <div class="calc-desc">
            По сумме кредита/займа
        </div>
        <div class="d-content-box">
            <el-row :gutter="20">
                <el-col :span="8" :xs="24" :sm="12" :md="8">
                    <div class="d-content-group">
                        <div class="d-content-label">Сумма кредита/займа</div>
                        <el-input v-model="sumLoan" @change="calculate"/>
                    </div>
                </el-col>
                <el-col :span="8" :xs="24" :sm="12" :md="8">
                    <div class="d-content-group">
                        <div class="d-content-label">Процентная ставка, % годовых</div>
                        <el-input v-model="bet" @change="calculate"/>
                    </div>
                </el-col>
                <el-col :span="8" :xs="24" :sm="12" :md="8">
                    <div class="d-content-multi">
                        <div class="d-content-group d-content-multi_left">
                            <div class="d-content-label">Срок кредита/займа</div>
                            <el-input v-model="periodLoan" @change="calculate"/>
                        </div>
                        <div class="d-content-group d-select">
                            <el-select v-model="periodType" class="m-2" placeholder="Select" size="large" @change="calculate">
                                <el-option
                                v-for="item in periods"
                                :key="item.value"
                                :label="item.label"
                                :value="item.value"
                                />
                            </el-select>
                        </div>
                    
                    </div>
                </el-col>

                <el-col :span="8" :xs="24" :sm="12" :md="8">
                    <div class="d-content-group">
                        <div class="d-content-label">Дата выдачи</div>
                        <el-date-picker
                            v-model="dateIssue"
                            type="date"
                            :clearable="false"
                            :isCurrent="true"
                            format="DD.MM.YYYY"
                            value-format="DD.MM.YYYY"
                            @change="calculate"
                        />
                    </div>
                </el-col>
                <el-col :span="8" :xs="24" :sm="24" :md="8">
                    <div class="d-content-group center-w d-select_t1">
                        <div class="d-content-label">Порядок погашения</div>
                        <el-select v-model="repaymentProcedure" class="m-2" size="large"  @change="calculate">
                            <el-option
                                v-for="item in repaymentProcedureType"
                                :key="item.value"
                                :label="item.label"
                                :value="item.value"
                            />
                        </el-select>
                    </div>
                </el-col>
                <el-col :span="8" :xs="24" :sm="12" :md="8">
                    <div class="d-content-group">
                        <div class="d-content-label">Единовременная комиссия</div>
                        <el-input v-model="oneCommission"  @change="calculate"/>
                    </div>
                </el-col>
                <el-col :span="8" :xs="24" :sm="12" :md="8">
                    <div class="d-content-group">
                        <div class="d-content-label">Ежегодная комиссия</div>
                        <el-input v-model="annuallyCommission"  @change="calculate"/>
                    </div>
                </el-col>
            </el-row>
        </div>
        
        <div class="d-content-total">
             <Total :sum="totalAll" :credit="totalPrice" :overpayment="totalOverpayment"/>
            <div class="btn-table-pay">
                <el-button class="d-green" @click="tableVisible = true">График платежей</el-button>
            </div>
        </div>

    </div>

    <el-dialog v-model="tableVisible" title="График платежей" width="70%" fullscreen="true">
        <el-table 
        :data="tablePay" 
        class="table-min"
        style="width: 100%"
        >
            <el-table-column label="Дата" width="100" align="center">
                <template #default="scope">
                    <div> 
                        {{ scope.row.date }} 
                    </div>
                </template>
            </el-table-column>
            <el-table-column label="Платеж" width="130" align="center">
                <template #default="scope">
                    <div> 
                        {{ scope.row.pay }} 
                    </div>
                </template>
            </el-table-column>
            <el-table-column label="Проценты" width="110" align="center">
                <template #default="scope">
                    <div> 
                        {{ scope.row.percent }} 
                    </div>
                </template>
            </el-table-column>
            <el-table-column label="Тело кредита" width="140" align="center">
                <template #default="scope">
                    <div> 
                        {{ scope.row.mainDebt }} 
                    </div>
                </template>
            </el-table-column>
            <el-table-column v-if="tablePay" label="Комиссия" width="100" align="center">
                <template #default="scope">
                    <div v-if="scope.row.commision"> 
                        {{ scope.row.commision }} 
                    </div>
                    <div v-else>0.00</div>
                </template>
            </el-table-column>
            <el-table-column label="Остаток" width="120" align="center">
                <template #default="scope">
                    <div> 
                        {{ scope.row.remainder }} 
                    </div>
                </template>
            </el-table-column>
        </el-table>
        <div class="total-box">
            <Total :sum="totalAll" :credit="totalPrice" :overpayment="totalOverpayment"/>
        </div>
        <el-button class="print d-green" circle @click="print">
            <el-icon><Printer /></el-icon>
         </el-button>
    </el-dialog>
  </div>
</template>

<style lang="scss">
.calc {
    margin-top: 30px;
    &-desc {
        font-size: 18px;
        background-color: #ffffff;
        color: black;
        width: fit-content;
        margin: auto;
        border-radius: 12px 12px 0 0;
        padding: 7px 20px 40px;
        font-weight: 600;
        cursor: default;
    }
}



.d-content {
    background-color: #fff;
    color: #181818;
    padding-top: 32px;
    border-radius: 30px;
    max-width: 940px;
    margin: auto;
    &-box {
        padding: 0 40px;
        @media (max-width: 480px) {
            padding: 0 20px;
        }
    }

    &-group {
        .el-input__inner {
            padding-top: 44px;
            padding-bottom: 20px;
            padding-left: 6px;
            font-size: 20px;
        }

        .el-input__wrapper {
            border-radius: 20px;
            border: 1px solid #f5f5f5;
            background-color: #f5f5f5;
            width: 100%;
            &.is-focus {
                box-shadow: 0 0 0 1px #000000 inset;
            }
        }
        .el-date-editor {
            width: 100%;
            height: auto;
            .el-input__prefix {
                position: absolute;
                right: 7px;
                .el-icon {
                    font-size: 30px;
                    color: #181818;
                }
            }
        }
        &.d-select_t1 .el-input__inner {
            font-size: 20px;
        }
        &.center-w {
            width: fit-content;
            margin: auto;
            @media (max-width: 768px) {
                width: 100%;
                .el-select {
                     width: 100%;
                }
            }
        }
    }

    &-label {
        text-align: left;
        font-size: 12px;
        padding-left: 20px;
        margin-bottom: -22px;
        z-index: 9;
        color: #000;
        line-height: 1;
        opacity: .7;
        overflow: hidden;
    }

    &-multi {
        display: flex;
        .d-select {
            max-width: 104px;
            margin-top: -10px;
            padding-left: 0;
        }
        .d-content-group {
            &.d-select {
                .el-input__inner {
                    font-size: 16px;
                    padding-top: 33px;
                    padding-bottom: 31px;
                }
                .el-input__wrapper {
                    border-radius: 0 20px 20px 0;
                    padding-left: 4px;
                }
            }
            &.d-content-multi_left {
                width: 100%;
                .el-input__wrapper {
                    border-radius: 20px 0 0 20px;
                }
            }
        }
    }

    &-block {
        padding-top: 45px;
    }

    &-total {
        font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: #181818;
        padding: 0 40px;
        box-shadow: 0 -3px 15px rgb(0 0 0 / 7%);
        margin-top: 10px;
        padding-top: 40px;
        padding-bottom: 40px;
        &-box {
            display: flex;
            width: 100%;
            justify-content: space-around;
            @media (max-width: 768px) {
                flex-wrap: wrap;
            }
        }
        @media (max-width: 768px) {
           flex-wrap: wrap;
           .btn-table-pay {
                flex-basis: 100%;
           }
        }
    }
}

.d-total-all {
    color: var(--vt-primal-1);
    font-weight: 700;
    transition: .3s;
    &_placeholder {
        color: var(--color-background);
        font-size: 18px;
        transition: .3s;
    }
    @media (max-width: 768px) {
        font-size: 20px;
        &_placeholder {
            font-size: 14px;
        }
    }
}

.d-green {
    background-color: var(--vt-primal-1);
    color: white;
    border-color: var(--vt-primal-1);
    &:hover,
    &:active,
    &:focus {
        color: var(--vt-c-white);
        border-color: var(--color-background);
        background-color: var(--color-background);
    }
}

.el-col {
  margin-bottom: 30px;
}

.el-dialog__title {
    color: var(--vt-primal-1);
    font-weight: 500;
    font-size: 24px;
    margin: auto;
    transition: .3s;
    @media (max-width: 480px) {
        font-size: 20px;
    }
}

.el-icon.el-dialog__close {
    font-size: 38px;
    &:hover {
        color: var(--vt-primal-1);
    }
}

.total-box {
    max-width: 780px;
    margin: auto;
    padding-top: 40px;
}

.table-min {
    width: 100%;
    max-width: 700px;
    margin: auto;
}

.print {
    margin-top: 50px;
}

@media print{
	input,.print,
    .el-icon.el-dialog__close {
		display:none
	}
	.printonly{
		display:block;
		width:50%
	}
    .el-dialog__title,
    .d-total-all {
        color: black;
    }
}
</style>