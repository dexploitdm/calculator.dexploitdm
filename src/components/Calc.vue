<script setup>
import { ref, onMounted } from 'vue'
import moment from 'moment'

// reactive state
const typeCalc = ref(false)
const sumLoan = ref(50000)
const bet = ref(22)
const periodLoan = ref(1)
const periodType = ref('year')
const periods = [ { value: 'year', label: 'года',}, { value: 'month', label: 'месяца',}]
const dateIssue = ref(moment().format('DD.MM.YYYY'))
const repaymentProcedure = ref('annuity')
const repaymentProcedureType = [ { value: 'annuity', label: 'Аннуитетный',}, { value: 'differentiated', label: 'Дифференцированный',}]
const RepaymentFrequency = ref('monthly')
const RepaymentFrequencyType = [ { value: 'monthly', label: 'Ежемесячно',}, { value: 'quarterly', label: 'Ежеквартально',}, { value: 'annually', label: 'Ежегодно',}]
const oneCommission = ref(0)
const annuallyCommission = ref(0)

const totalAll = ref(0)
const totalPrice = ref(0)
const totalOverpayment = ref(0)

let tablePay = ref([])


// functions that mutate state and trigger updates
function calculate() {
    repaymentProcedure.value === 'annuity' ? annuityCalculate() : differentiatedCalculate()
}

function annuityCalculate() {
    tablePay.value = []

    let period = periodLoan.value
    if (periodType.value === 'year') {
        period = period * 12
    }

  
    //ежемесячная процентная ставка
    const p = Number((bet.value /100/12).toFixed(6) * 3)


    //сумма ежемесячных отчислений по кредиту
    const n = p / (Math.pow(1+p, period) - 1);
    const annuityPay = sumLoan.value * (p + n)
    totalPrice.value = annuityPay.toFixed(2)

    console.log('annuityPay = ' + annuityPay)

    const startItem = {
        date: dateIssue.value,
        pay: '0.00',
        percent: '0.00',
        mainDebt: '0.00',
        remainder: sumLoan.value
    }

    //Коммисия
    if(Number(oneCommission.value) > 0){
        startItem.pay = Number(oneCommission.value).toFixed(2)
        startItem.commision = Number(oneCommission.value).toFixed(2)
    }
    if(Number(annuallyCommission.value) > 0){
        totalPrice.value = Number(annuityPay.toFixed(2)) + Number(annuallyCommission.value)
    }


    tablePay.value.push(startItem)

    let datePay = moment(dateIssue.value, 'DD MM YYYY');
    //let remainder = sumLoan.value + (sumLoan.value * p)
    let remainder = sumLoan.value
    let totalPay = startItem.pay
    let totalPercent = 0


    for (var i = 0; i < period; i++) {
        datePay = moment(datePay).add(1, 'M');
        const percent = remainder * p
        //TODO: Заменить remainder на 

        console.log('remainder ' + remainder + ' p = ' + p)
        const remainderSum = remainder

        let mainDebt = annuityPay - percent

        remainder = Number(tablePay.value[i].remainder) - mainDebt

        let pay = annuityPay
  
        if((i + 1) === period) {
            mainDebt = Number(tablePay.value[i].remainder)
            pay = percent + Number(tablePay.value[i].remainder)
            remainder = 0
            console.log('END')
            console.log(tablePay.value[i].remainder)
        }

        if(Number(annuallyCommission.value) > 0){
            pay = Number(pay.toFixed(2)) + Number(annuallyCommission.value)
        }

        console.log(pay)

        const tableItem = {
            date: datePay.format('DD.MM.YYYY'),
            pay: pay.toFixed(2),
            percent: percent.toFixed(2),
            mainDebt: mainDebt.toFixed(2),
            remainder: remainder.toFixed(2)
        }

        if(Number(annuallyCommission.value) > 0){
            tableItem.commision = Number(annuallyCommission.value).toFixed(2)
        }

        totalPay = Number(totalPay) + pay
        totalPercent = totalPercent + percent


        tablePay.value.push(tableItem)
        
    }

    totalAll.value = totalPay.toFixed(2)
    totalOverpayment.value = totalPercent.toFixed(2)
    
}

function differentiatedCalculate() {
    console.log(`differentiatedCalculate`)
}



// lifecycle hooks
onMounted(() => {
 
    calculate()
})
</script>
<template>
  <div class="calc center">
    <div class="calc-trigger">
        <el-switch
            v-model="typeCalc"
            class="mb-2 style-tab"
            style="--el-switch-on-color: #00bd7e;"
            active-text="По сумме платежа"
            inactive-text="По сумме кредита/займа"
        />
    </div>
    <div class="d-content">
        <div class="d-content-box">
            <el-row>
                <el-col :span="8">
                    <div class="d-content-group">
                        <div class="d-content-label">Сумма кредита/займа</div>
                        <el-input v-model="sumLoan" @change="calculate"/>
                    </div>
                </el-col>
                <el-col :span="8">
                    <div class="d-content-group pad">
                        <div class="d-content-label">Процентная ставка, % годовых</div>
                        <el-input v-model="bet" @change="calculate"/>
                    </div>
                </el-col>
                <el-col :span="8">
                    <div class="d-content-multi">
                        <div class="d-content-group pad d-content-multi_left">
                            <div class="d-content-label">Срок кредита/займа</div>
                            <el-input v-model="periodLoan" @change="calculate"/>
                        </div>
                        <div class="d-content-group d-select">
                            <el-select v-model="periodType" class="m-2" placeholder="Select" size="large" @change="calculate">
                                <el-option
                                v-for="item in periods"
                                :key="item.value"
                                :label="item.label"
                                :value="item.value"
                                />
                            </el-select>
                        </div>
                    
                    </div>
                </el-col>
            </el-row>

            <div class="d-content-block">
                <el-row>
                    <el-col :span="8">
                        <div class="d-content-group">
                            <div class="d-content-label">Дата выдачи</div>
                            <el-date-picker
                                v-model="dateIssue"
                                type="date"
                                :clearable="false"
                                :isCurrent="true"
                                format="DD.MM.YYYY"
                                value-format="DD.MM.YYYY"
                                 @change="calculate"
                            />
                        </div>
                    </el-col>
                    <el-col :span="8">
                        <div class="d-content-group d-select_t1 pad">
                            <div class="d-content-label">Порядок погашения</div>
                            <el-select v-model="repaymentProcedure" class="m-2" size="large"  @change="calculate">
                                <el-option
                                v-for="item in repaymentProcedureType"
                                :key="item.value"
                                :label="item.label"
                                :value="item.value"
                                />
                            </el-select>
                        </div>
                    </el-col>
                    <el-col :span="8">
                        <div class="d-content-group d-select_t1 pad">
                            <div class="d-content-label">Периодичность погашения</div>
                            <el-select v-model="RepaymentFrequency" class="m-2" size="large"  @change="calculate">
                                <el-option
                                v-for="item in RepaymentFrequencyType"
                                :key="item.value"
                                :label="item.label"
                                :value="item.value"
                                />
                            </el-select>
                        </div>
                    </el-col>

                </el-row>
            </div>

            <div class="d-content-block">
                <el-row>
                    <el-col :span="8">
                        <div class="d-content-group">
                            <div class="d-content-label">Единовременная комиссия</div>
                            <el-input v-model="oneCommission"  @change="calculate"/>
                        </div>
                    </el-col>
                    <el-col :span="8">
                        <div class="d-content-group pad">
                            <div class="d-content-label">Ежегодная комиссия</div>
                            <el-input v-model="annuallyCommission"  @change="calculate"/>
                        </div>
                    </el-col>
                    

                </el-row>
            </div>
        </div>
        

        <div class="d-content-total">
            <div class="d-total-all">
                {{ totalAll }} ₽
            </div>
            <div class="full-price">
                {{ totalPrice }}  ₽
            </div>
            <div class="overpayment">
                {{ totalOverpayment }} ₽
            </div>
            <div class="btn-table-pay">
                <el-button>График платежей</el-button>
            </div>
        </div>

        <el-table 
        :data="tablePay" 
        style="width: 100%"
        >
            <el-table-column label="Дата" width="180" align="center">
                <template #default="scope">
                    <div> 
                        {{ scope.row.date }} 
                    </div>
                </template>
            </el-table-column>
            <el-table-column label="Платеж" align="center">
                <template #default="scope">
                    <div> 
                        {{ scope.row.pay }} 
                    </div>
                </template>
            </el-table-column>
            <el-table-column label="Проценты" align="center">
                <template #default="scope">
                    <div> 
                        {{ scope.row.percent }} 
                    </div>
                </template>
            </el-table-column>
            <el-table-column label="Тело кредита" align="center">
                <template #default="scope">
                    <div> 
                        {{ scope.row.mainDebt }} 
                    </div>
                </template>
            </el-table-column>
            <el-table-column v-if="tablePay[0] && (tablePay[0].commision || tablePay[1].commision)" label="Комиссия" align="center">
                <template #default="scope">
                    <div v-if="scope.row.commision"> 
                        {{ scope.row.commision }} 
                    </div>
                    <div v-else>0.00</div>
                </template>
            </el-table-column>
            <el-table-column label="Остаток" width="180" align="center">
                <template #default="scope">
                    <div> 
                        {{ scope.row.remainder }} 
                    </div>
                </template>
            </el-table-column>
        </el-table>


    </div>
  </div>
</template>

<style>


</style>
